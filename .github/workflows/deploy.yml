name: Build and Deploy

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 23 for x64
        uses: actions/setup-java@v4
        with:
          java-version: "23"
          distribution: "oracle"
          architecture: x64

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Write SSH key to file
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > /tmp/deploy_key
          chmod 600 /tmp/deploy_key

      # - name: (Optional) Debug SSH connectivity
      #   run: |
      #     ssh -o StrictHostKeyChecking=no -i /tmp/deploy_key ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} 'echo CI_SSH_OK'

      - name: Deploy artifact via scp
        run: |
          scp -o StrictHostKeyChecking=no -i /tmp/deploy_key target/cup.jar ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/opt/cup/incoming/

      - name: Run deployment script
        run: |
          ssh -o StrictHostKeyChecking=no -i /tmp/deploy_key ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} /opt/scripts/deploy.sh
